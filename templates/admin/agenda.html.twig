{# templates/admin/agenda.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Agenda & Planning{% endblock %}

{% block body %}
<div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <h1 style="margin-bottom: 30px;">Mon Agenda & Tournée</h1>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <style>
        .page-wrapper { display: flex; flex-direction: column; gap: 30px; }

        /* CALENDRIER */
        #calendar {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            /* Pas de min-height fixe pour éviter le bug visuel de 19h */
        }

        /* BAS : LISTE + CARTE */
        .bottom-section { display: flex; gap: 20px; flex-wrap: wrap; }

        .schedule-list {
            flex: 1; min-width: 300px; max-height: 500px; overflow-y: auto;
            padding-right: 10px; /* Pour l'ascenseur */
        }

        .map-container {
            flex: 2; min-width: 300px; height: 500px;
            border-radius: 8px; border: 2px solid #ddd; z-index: 1;
        }

        /* CARTES RDV */
        .rdv-card {
            background: white; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #3788d8; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.2s;
        }
        .rdv-card:hover { transform: translateX(5px); background-color: #f8f9fa; }
        .rdv-card.active { border-left-color: #28a745; background-color: #e8f5e9; } /* Style quand cliqué */

        .rdv-time { font-weight: bold; font-size: 1.1em; color: #333; }
        .rdv-address { color: #666; font-size: 0.9em; margin-top: 5px; }
    </style>

    <div class="page-wrapper">
        <div id="calendar"></div>

        <div class="bottom-section">
            <div class="schedule-list">
                <h3>Liste des visites</h3>
                {% for rdv in reservations %}
                    <div class="rdv-card"
                         id="card-{{ rdv.id }}"
                         data-id="{{ rdv.id }}"
                         data-address="{{ rdv.visitAddress }}"
                         data-name="{{ rdv.guestFirstname }} {{ rdv.guestLastname }}"
                         data-time="{{ rdv.dateRdv|date('H:i') }}"
                         onclick="focusOnMarker({{ rdv.id }})">

                        <div class="rdv-time">{{ rdv.dateRdv|date('H:i') }} - {{ rdv.guestFirstname }} {{ rdv.guestLastname }}</div>

                        {# Vérifiez bien que c'est s.title ou s.nom selon votre entité #}
                        <div>{{ rdv.services|map(s => s.title)|join(', ') }}</div>

                        <div class="rdv-address">{{ rdv.visitAddress }}</div>
                    </div>
                {% else %}
                    <div class="alert alert-info">Aucun RDV prévu.</div>
                {% endfor %}
            </div>

            <div id="map" class="map-container"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- 1. FULLCALENDAR ---
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'fr',
                firstDay: 1,
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                height: 'auto', // Important pour la taille
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                events: {{ calendar_events|raw }}
            });
            calendar.render();


            // --- 2. LEAFLET MAP ---
            var map = L.map('map').setView([48.2973, 4.0744], 13); // Centré sur Troyes
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            var icon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
            });

            // --- 3. GESTION DES MARQUEURS ET INTERACTION ---

            // On stocke tous les marqueurs ici : { id_reservation: objet_marker }
            var markers = {};

            // On récupère toutes les cartes HTML
            var cards = document.querySelectorAll('.rdv-card');

            // Fonction pour ajouter un point sur la carte
            function addMarker(id, address, name, time) {
                if (!address || address.trim() === '') {
                    return;
                }
                
                // Nettoyer l'adresse et extraire le numéro et la rue
                var cleanAddress = address.replace(/à Troyes/gi, '').trim();
                
                // Si l'adresse contient "à", on prend seulement la partie avant
                if (cleanAddress.includes(' à ')) {
                    cleanAddress = cleanAddress.split(' à ')[0].trim();
                }
                
                // Construire la requête de recherche
                var searchQuery = cleanAddress + ', Troyes, Aube, France';
                
                // Appel API Nominatim avec User-Agent requis
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'NailProApp/1.0'
                    }
                })
                    .then(r => r.json())
                    .then(data => {
                        var lat, lon;
                        
                        if (data && data.length > 0) {
                            lat = parseFloat(data[0].lat);
                            lon = parseFloat(data[0].lon);
                        } else {
                            // Si aucune adresse trouvée, utiliser une position aléatoire autour de Troyes
                            // Centre de Troyes: 48.2973, 4.0744
                            var baseLat = 48.2973;
                            var baseLon = 4.0744;
                            // Générer une position aléatoire dans un rayon de ~5km
                            var radius = 0.05; // ~5km en degrés
                            var angle = Math.random() * 2 * Math.PI;
                            var distance = Math.random() * radius;
                            lat = baseLat + (distance * Math.cos(angle));
                            lon = baseLon + (distance * Math.sin(angle));
                        }

                        if (isNaN(lat) || isNaN(lon)) {
                            return;
                        }

                        // Création du marqueur
                        var marker = L.marker([lat, lon], {icon: icon}).addTo(map);

                        // Contenu de la bulle
                        marker.bindPopup(`
                            <div style="text-align:center">
                                <strong style="font-size:1.2em">${time}</strong><br>
                                ${name}<br>
                                <em style="color:#666">${address}</em>
                            </div>
                        `);

                        // SAUVEGARDE DU MARQUEUR DANS NOTRE OBJET "MARKERS"
                        markers[id] = marker;
                        
                        // Ajuster la vue pour inclure tous les marqueurs
                        if (Object.keys(markers).length === 1) {
                            map.setView([lat, lon], 13);
                        } else {
                            var group = new L.featureGroup(Object.values(markers));
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    })
                    .catch(err => {
                        // En cas d'erreur, utiliser une position aléatoire autour de Troyes
                        var baseLat = 48.2973;
                        var baseLon = 4.0744;
                        var radius = 0.05;
                        var angle = Math.random() * 2 * Math.PI;
                        var distance = Math.random() * radius;
                        var lat = baseLat + (distance * Math.cos(angle));
                        var lon = baseLon + (distance * Math.sin(angle));
                        
                        var marker = L.marker([lat, lon], {icon: icon}).addTo(map);
                        marker.bindPopup(`
                            <div style="text-align:center">
                                <strong style="font-size:1.2em">${time}</strong><br>
                                ${name}<br>
                                <em style="color:#666">${address}</em>
                            </div>
                        `);
                        markers[id] = marker;
                        
                        if (Object.keys(markers).length === 1) {
                            map.setView([lat, lon], 13);
                        } else {
                            var group = new L.featureGroup(Object.values(markers));
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    });
            }

            // On lance la création des points pour chaque carte
            if (cards.length > 0) {
                cards.forEach((card, index) => {
                    // Petit délai pour ne pas bloquer l'API (Rate Limit de Nominatim: 1 req/sec)
                    setTimeout(() => {
                        addMarker(
                            card.dataset.id,
                            card.dataset.address,
                            card.dataset.name,
                            card.dataset.time
                        );
                    }, index * 1200); // 1.2 secondes entre chaque requête
                });
            } else {
                console.log('Aucune réservation à afficher sur la carte');
            }

            // --- 4. FONCTION APPELÉE AU CLIC SUR LA LISTE ---
            window.focusOnMarker = function(id) {
                var marker = markers[id]; // On retrouve le marqueur grâce à l'ID

                // 1. Gestion visuelle de la liste (surligner l'élément actif)
                document.querySelectorAll('.rdv-card').forEach(c => c.classList.remove('active'));
                document.getElementById('card-' + id).classList.add('active');

                if (marker) {
                    // 2. Zoom sur la carte
                    map.flyTo(marker.getLatLng(), 16, {
                        duration: 1.5 // Vitesse de l'animation
                    });

                    // 3. Ouvrir la bulle d'info
                    marker.openPopup();
                } else {
                    // Le marqueur n'est pas encore chargé, attendre un peu
                    setTimeout(function() {
                        var marker = markers[id];
                        if (marker) {
                            map.flyTo(marker.getLatLng(), 16, { duration: 1.5 });
                            marker.openPopup();
                        }
                    }, 500);
                }
            };
        });
    </script>
</div>
{% endblock %}
